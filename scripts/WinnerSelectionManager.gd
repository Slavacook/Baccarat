# res://scripts/WinnerSelectionManager.gd
# –ú–µ–Ω–µ–¥–∂–µ—Ä –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —á–µ—Ä–µ–∑ toggleable –º–∞—Ä–∫–µ—Ä—ã

class_name WinnerSelectionManager
extends RefCounted

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –°–ò–ì–ù–ê–õ–´
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

signal winner_toggled(winner: String, selected: bool)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ü–ï–†–ï–ú–ï–ù–ù–´–ï
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# –°–ª–æ–≤–∞—Ä—å –º–∞—Ä–∫–µ—Ä–æ–≤: {"Player": TextureButton, "Banker": TextureButton, "Tie": TextureButton}
var marker_nodes: Dictionary = {}

# –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å (–∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω)
var selected_winner: String = ""

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

func setup(player_marker: TextureButton, banker_marker: TextureButton, tie_marker: TextureButton):
	"""–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤"""
	marker_nodes["Player"] = player_marker
	marker_nodes["Banker"] = banker_marker
	marker_nodes["Tie"] = tie_marker

	# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∫ –∫–∞–∂–¥–æ–º—É –º–∞—Ä–∫–µ—Ä—É
	for winner_type in marker_nodes.keys():
		var marker = marker_nodes[winner_type]
		# –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ TextureButton
		marker.pressed.connect(_on_marker_clicked.bind(winner_type))

	print("‚úÖ WinnerSelectionManager: –º–∞—Ä–∫–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–´–ë–û–†–û–ú
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

func toggle_winner(winner: String) -> void:
	"""–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (select ‚Üî deselect)"""
	if not marker_nodes.has(winner):
		push_error("WinnerSelectionManager: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å '%s'" % winner)
		return

	if selected_winner == winner:
		# –£–∂–µ –≤—ã–±—Ä–∞–Ω ‚Üí —Å–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä
		deselect_winner()
	else:
		# –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤–æ–≥–æ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π)
		select_winner(winner)


func select_winner(winner: String) -> void:
	"""–í—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (—Å–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä)"""
	if not marker_nodes.has(winner):
		push_error("WinnerSelectionManager: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å '%s'" % winner)
		return

	# –°–Ω–∏–º–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä (–µ—Å–ª–∏ –±—ã–ª)
	if selected_winner != "":
		_set_marker_state(selected_winner, false)

	# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –≤—ã–±–æ—Ä
	selected_winner = winner
	_set_marker_state(winner, true)

	winner_toggled.emit(winner, true)
	print("üéØ WinnerSelectionManager: –≤—ã–±—Ä–∞–Ω %s" % winner)


func deselect_winner() -> void:
	"""–°–Ω—è—Ç—å –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è"""
	if selected_winner == "":
		return

	var previous_winner = selected_winner
	_set_marker_state(selected_winner, false)
	selected_winner = ""

	winner_toggled.emit(previous_winner, false)
	print("üéØ WinnerSelectionManager: –≤—ã–±–æ—Ä —Å–Ω—è—Ç")


func get_selected_winner() -> String:
	"""–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å"""
	return selected_winner


func is_winner_selected() -> bool:
	"""–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—ã–±—Ä–∞–Ω –ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å"""
	return selected_winner != ""


func reset() -> void:
	"""–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä (–¥–ª—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã)"""
	deselect_winner()


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–û–í
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

func _on_marker_clicked(winner: String) -> void:
	"""–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä"""
	toggle_winner(winner)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –í–ò–ó–£–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ú–ê–†–ö–ï–†–û–í
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

func _set_marker_state(winner: String, pressed: bool) -> void:
	"""–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ (–Ω–∞–∂–∞—Ç/–Ω–µ –Ω–∞–∂–∞—Ç)"""
	var marker = marker_nodes[winner]

	# TextureButton –∏–º–µ–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ button_pressed –¥–ª—è toggle mode
	# –ù–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º feedback
	# –ü–æ—ç—Ç–æ–º—É —É–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —á–µ—Ä–µ–∑ modulate –∏–ª–∏ scale

	if pressed:
		# –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)
		marker.modulate = Color(1.2, 1.2, 1.2)  # –ù–µ–º–Ω–æ–≥–æ —è—Ä—á–µ
		marker.scale = Vector2(1.1, 1.1) * Vector2(0.2, 0.2)  # –ù–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ (–±–∞–∑–æ–≤—ã–π scale 0.2)
	else:
		# –û–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
		marker.modulate = Color(1.0, 1.0, 1.0)
		marker.scale = Vector2(0.2, 0.2)
